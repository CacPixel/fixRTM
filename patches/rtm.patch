diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/RTMItem.jasm b/src/main/rtm/jp/ngt/rtm/RTMItem.jasm
index 3762a0f..ee55f17 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/RTMItem.jasm
+++ b/src/main/rtm/jp/ngt/rtm/RTMItem.jasm
@@ -667,21 +667,21 @@ L_0012:
 L_0018:
     .line 154
     getstatic jp/ngt/rtm/RTMItem/itemtrain Lnet/minecraft/item/Item;
     iconst_3
     ldc "item_train_3"
     invokestatic jp/ngt/rtm/RTMItem/registerItemModel (Lnet/minecraft/item/Item;ILjava/lang/String;)V
 L_001e:
     .line 155
     getstatic jp/ngt/rtm/RTMItem/itemtrain Lnet/minecraft/item/Item;
     bipush 127
-    ldc "item_train_127"
+    ldc "item_train_fixrtm_test"
     invokestatic jp/ngt/rtm/RTMItem/registerItemModel (Lnet/minecraft/item/Item;ILjava/lang/String;)V
 L_0024:
     .line 156
     getstatic jp/ngt/rtm/RTMItem/itemMotorman Lnet/minecraft/item/Item;
     iconst_0
     ldc "item_npc_0"
     invokestatic jp/ngt/rtm/RTMItem/registerItemModel (Lnet/minecraft/item/Item;ILjava/lang/String;)V
 L_002a:
     .line 157
     getstatic jp/ngt/rtm/RTMItem/itemMotorman Lnet/minecraft/item/Item;
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/RTMRecipe.jasm b/src/main/rtm/jp/ngt/rtm/RTMRecipe.jasm
index e14c0e6..5de27d3 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/RTMRecipe.jasm
+++ b/src/main/rtm/jp/ngt/rtm/RTMRecipe.jasm
@@ -5771,95 +5771,131 @@ L_15e8:
     new jp/ngt/ngtlib/item/craft/RepairRecipe
     dup
     getstatic jp/ngt/rtm/RTMItem/magazine_handgun Lnet/minecraft/item/Item;
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/bullet Lnet/minecraft/item/Item;
     iconst_1
     iconst_4
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
     invokespecial jp/ngt/ngtlib/item/craft/RepairRecipe/<init> (Lnet/minecraft/item/Item;Lnet/minecraft/item/ItemStack;)V
+    new net/minecraft/util/ResourceLocation
+    dup
+    ldc "rtm"
+    ldc "_magazine_handgun"
+    invokespecial net/minecraft/util/ResourceLocation/<init> (Ljava/lang/String;Ljava/lang/String;)V
+    invokevirtual jp/ngt/ngtlib/item/craft/RepairRecipe/setRegistryName (Lnet/minecraft/util/ResourceLocation;)Lnet/minecraft/item/crafting/IRecipe;
     invokevirtual jp/ngt/ngtlib/item/craft/RecipeManager/addRecipeToManager (Lnet/minecraft/item/crafting/IRecipe;)Lnet/minecraft/item/crafting/IRecipe;
     pop
 L_15f7:
     .line 488
     getstatic jp/ngt/ngtlib/item/craft/RecipeManager/INSTANCE Ljp/ngt/ngtlib/item/craft/RecipeManager;
     new jp/ngt/ngtlib/item/craft/RepairRecipe
     dup
     getstatic jp/ngt/rtm/RTMItem/magazine_rifle Lnet/minecraft/item/Item;
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/bullet Lnet/minecraft/item/Item;
     iconst_1
     bipush 12
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
     invokespecial jp/ngt/ngtlib/item/craft/RepairRecipe/<init> (Lnet/minecraft/item/Item;Lnet/minecraft/item/ItemStack;)V
+    new net/minecraft/util/ResourceLocation
+    dup
+    ldc "rtm"
+    ldc "_magazine_rifle"
+    invokespecial net/minecraft/util/ResourceLocation/<init> (Ljava/lang/String;Ljava/lang/String;)V
+    invokevirtual jp/ngt/ngtlib/item/craft/RepairRecipe/setRegistryName (Lnet/minecraft/util/ResourceLocation;)Lnet/minecraft/item/crafting/IRecipe;
     invokevirtual jp/ngt/ngtlib/item/craft/RecipeManager/addRecipeToManager (Lnet/minecraft/item/crafting/IRecipe;)Lnet/minecraft/item/crafting/IRecipe;
     pop
 L_1606:
     .line 489
     getstatic jp/ngt/ngtlib/item/craft/RecipeManager/INSTANCE Ljp/ngt/ngtlib/item/craft/RecipeManager;
     new jp/ngt/ngtlib/item/craft/RepairRecipe
     dup
     getstatic jp/ngt/rtm/RTMItem/magazine_alr Lnet/minecraft/item/Item;
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/bullet Lnet/minecraft/item/Item;
     iconst_1
     bipush 12
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
     invokespecial jp/ngt/ngtlib/item/craft/RepairRecipe/<init> (Lnet/minecraft/item/Item;Lnet/minecraft/item/ItemStack;)V
+    new net/minecraft/util/ResourceLocation
+    dup
+    ldc "rtm"
+    ldc "_magazine_alr"
+    invokespecial net/minecraft/util/ResourceLocation/<init> (Ljava/lang/String;Ljava/lang/String;)V
+    invokevirtual jp/ngt/ngtlib/item/craft/RepairRecipe/setRegistryName (Lnet/minecraft/util/ResourceLocation;)Lnet/minecraft/item/crafting/IRecipe;
     invokevirtual jp/ngt/ngtlib/item/craft/RecipeManager/addRecipeToManager (Lnet/minecraft/item/crafting/IRecipe;)Lnet/minecraft/item/crafting/IRecipe;
     pop
 L_1615:
     .line 490
     getstatic jp/ngt/ngtlib/item/craft/RecipeManager/INSTANCE Ljp/ngt/ngtlib/item/craft/RecipeManager;
     new jp/ngt/ngtlib/item/craft/RepairRecipe
     dup
     getstatic jp/ngt/rtm/RTMItem/magazine_sr Lnet/minecraft/item/Item;
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/bullet Lnet/minecraft/item/Item;
     iconst_1
     bipush 12
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
     invokespecial jp/ngt/ngtlib/item/craft/RepairRecipe/<init> (Lnet/minecraft/item/Item;Lnet/minecraft/item/ItemStack;)V
+    new net/minecraft/util/ResourceLocation
+    dup
+    ldc "rtm"
+    ldc "_magazine_sr"
+    invokespecial net/minecraft/util/ResourceLocation/<init> (Ljava/lang/String;Ljava/lang/String;)V
+    invokevirtual jp/ngt/ngtlib/item/craft/RepairRecipe/setRegistryName (Lnet/minecraft/util/ResourceLocation;)Lnet/minecraft/item/crafting/IRecipe;
     invokevirtual jp/ngt/ngtlib/item/craft/RecipeManager/addRecipeToManager (Lnet/minecraft/item/crafting/IRecipe;)Lnet/minecraft/item/crafting/IRecipe;
     pop
 L_1624:
     .line 491
     getstatic jp/ngt/ngtlib/item/craft/RecipeManager/INSTANCE Ljp/ngt/ngtlib/item/craft/RecipeManager;
     new jp/ngt/ngtlib/item/craft/RepairRecipe
     dup
     getstatic jp/ngt/rtm/RTMItem/magazine_smg Lnet/minecraft/item/Item;
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/bullet Lnet/minecraft/item/Item;
     iconst_1
     iconst_4
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
     invokespecial jp/ngt/ngtlib/item/craft/RepairRecipe/<init> (Lnet/minecraft/item/Item;Lnet/minecraft/item/ItemStack;)V
+    new net/minecraft/util/ResourceLocation
+    dup
+    ldc "rtm"
+    ldc "_magazine_smg"
+    invokespecial net/minecraft/util/ResourceLocation/<init> (Ljava/lang/String;Ljava/lang/String;)V
+    invokevirtual jp/ngt/ngtlib/item/craft/RepairRecipe/setRegistryName (Lnet/minecraft/util/ResourceLocation;)Lnet/minecraft/item/crafting/IRecipe;
     invokevirtual jp/ngt/ngtlib/item/craft/RecipeManager/addRecipeToManager (Lnet/minecraft/item/crafting/IRecipe;)Lnet/minecraft/item/crafting/IRecipe;
     pop
 L_1633:
     .line 492
     getstatic jp/ngt/ngtlib/item/craft/RecipeManager/INSTANCE Ljp/ngt/ngtlib/item/craft/RecipeManager;
     new jp/ngt/ngtlib/item/craft/RepairRecipe
     dup
     getstatic jp/ngt/rtm/RTMItem/magazine_amr Lnet/minecraft/item/Item;
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/bullet Lnet/minecraft/item/Item;
     iconst_1
     bipush 16
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
     invokespecial jp/ngt/ngtlib/item/craft/RepairRecipe/<init> (Lnet/minecraft/item/Item;Lnet/minecraft/item/ItemStack;)V
+    new net/minecraft/util/ResourceLocation
+    dup
+    ldc "rtm"
+    ldc "_magazine_amr"
+    invokespecial net/minecraft/util/ResourceLocation/<init> (Ljava/lang/String;Ljava/lang/String;)V
+    invokevirtual jp/ngt/ngtlib/item/craft/RepairRecipe/setRegistryName (Lnet/minecraft/util/ResourceLocation;)Lnet/minecraft/item/crafting/IRecipe;
     invokevirtual jp/ngt/ngtlib/item/craft/RecipeManager/addRecipeToManager (Lnet/minecraft/item/crafting/IRecipe;)Lnet/minecraft/item/crafting/IRecipe;
     pop
 L_1642:
     .line 495
     new net/minecraft/item/ItemStack
     dup
     getstatic jp/ngt/rtm/RTMItem/material Lnet/minecraft/item/Item;
     bipush 64
     iconst_4
     invokespecial net/minecraft/item/ItemStack/<init> (Lnet/minecraft/item/Item;II)V
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/ai/EntityAITravelByTrain.jasm b/src/main/rtm/jp/ngt/rtm/entity/ai/EntityAITravelByTrain.jasm
index d9b0787..a04bd4e 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/ai/EntityAITravelByTrain.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/ai/EntityAITravelByTrain.jasm
@@ -200,42 +200,43 @@ L_0062:
     .end stack
     aload 0
     getfield jp/ngt/rtm/entity/ai/EntityAITravelByTrain/activeTask Lnet/minecraft/entity/ai/EntityAIBase;
     invokevirtual net/minecraft/entity/ai/EntityAIBase/shouldExecute ()Z
     ireturn
 L_0069:
 .end method
 
 .method private dismount ()V
     .limit stack 2
-    .limit local 1
-L_0000:
-    .line 77
-    .var 0 is this Ljp/ngt/rtm/entity/ai/EntityAITravelByTrain; from L_0000 to L_0013
-    aload 0
-    getfield jp/ngt/rtm/entity/ai/EntityAITravelByTrain/npc Ljp/ngt/rtm/entity/npc/EntityNPC;
-    aconst_null
-    invokevirtual jp/ngt/rtm/entity/npc/EntityNPC/startRiding (Lnet/minecraft/entity/Entity;)Z
-    pop
-L_0007:
-    .line 78
+    .limit local 2
+L_begin:
+    .line 10077
+    .var 0 is this Ljp/ngt/rtm/entity/ai/EntityAITravelByTrain; from L_begin to L_end
     aload 0
     getfield jp/ngt/rtm/entity/ai/EntityAITravelByTrain/npc Ljp/ngt/rtm/entity/npc/EntityNPC;
     invokevirtual jp/ngt/rtm/entity/npc/EntityNPC/getRidingEntity ()Lnet/minecraft/entity/Entity;
     checkcast jp/ngt/rtm/entity/train/parts/EntityFloor
+    astore 1
+L_floor_begin:
+    .line 10078
+    .var 1 is floor Ljp/ngt/rtm/entity/train/parts/EntityFloor; from L_floor_begin to L_end
+    aload 0
+    getfield jp/ngt/rtm/entity/ai/EntityAITravelByTrain/npc Ljp/ngt/rtm/entity/npc/EntityNPC;
+    invokevirtual jp/ngt/rtm/entity/npc/EntityNPC/dismountRidingEntity ()V
+    .line 10079
+    aload 1
     aload 0
     getfield jp/ngt/rtm/entity/ai/EntityAITravelByTrain/npc Ljp/ngt/rtm/entity/npc/EntityNPC;
     invokevirtual jp/ngt/rtm/entity/train/parts/EntityFloor/onDismount (Lnet/minecraft/entity/Entity;)V
-L_0010:
-    .line 79
+    .line 10080
     return
-L_0013:
+L_end:
 .end method
 
 .method public shouldContinueExecuting ()Z
     .limit stack 3
     .limit local 2
 L_0000:
     .line 84
     .var 0 is this Ljp/ngt/rtm/entity/ai/EntityAITravelByTrain; from L_0000 to L_006e
     aload 0
     getfield jp/ngt/rtm/entity/ai/EntityAITravelByTrain/activeTask Lnet/minecraft/entity/ai/EntityAIBase;
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/train/EntityBogie.jasm b/src/main/rtm/jp/ngt/rtm/entity/train/EntityBogie.jasm
index 58704f1..5e741cc 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/train/EntityBogie.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/train/EntityBogie.jasm
@@ -128,20 +128,22 @@ L_0020:
     iconst_1
     putfield jp/ngt/rtm/entity/train/EntityBogie/preventEntitySpawning Z
 L_0025:
     .line 81
     aload 0
     ldc 2.75f
     ldc 1.1875f
     invokevirtual jp/ngt/rtm/entity/train/EntityBogie/setBogieSize (FF)V
 L_002b:
     .line 82
+    aload 0
+    invokestatic com/anatawa12/fixRtm/rtm/entity/train/EntityBogieKt/constructor (Ljp/ngt/rtm/entity/train/EntityBogie;)V
     return
 L_002e:
 .end method
 
 .method public <init> (Lnet/minecraft/world/World;BLjp/ngt/rtm/entity/train/EntityTrainBase;)V
     .limit stack 2
     .limit local 4
 L_0000:
     .line 86
     .var 0 is this Ljp/ngt/rtm/entity/train/EntityBogie; from L_0000 to L_0012
@@ -1547,24 +1549,34 @@ L_0012:
     .end stack
     iconst_0
     istore 1
 L_0017:
     .line 376
     .stack use locals
     .end stack
     aload 0
     invokevirtual jp/ngt/rtm/entity/train/EntityBogie/getTrain ()Ljp/ngt/rtm/entity/train/EntityTrainBase;
     ifnonnull L_0021
+
+    .line 1378
+    aload 0
+    getfield jp/ngt/rtm/entity/train/EntityBogie/world Lnet/minecraft/world/World;
+    getfield net/minecraft/world/World/isRemote Z
+    ifne L_ifRemote
+
 L_001d:
     .line 378
     aload 0
     invokevirtual jp/ngt/rtm/entity/train/EntityBogie/setDead ()V
+
+L_ifRemote:
+
 L_0021:
     .line 380
     .stack use locals
     .end stack
     return
 L_0025:
 .end method
 
 .method public onBogieUpdate ()V
     .limit stack 2
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/train/EntityTrainBase.jasm b/src/main/rtm/jp/ngt/rtm/entity/train/EntityTrainBase.jasm
index 2fe97f1..299abdb 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/train/EntityTrainBase.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/train/EntityTrainBase.jasm
@@ -66,20 +66,23 @@
 .field private final loadedChunks Ljava/util/Set;
     .signature "Ljava/util/Set<Lnet/minecraft/util/math/ChunkPos;>;"
 .end field
 
 .field private prevChunkCoordX I
 .end field
 
 .field private prevChunkCoordZ I
 .end field
 
+.field private prevChunkLoaderRadius I
+.end field
+
 .method public <init> (Lnet/minecraft/world/World;)V
     .limit stack 3
     .limit local 2
 L_0000:
     .line 89
     .var 0 is this Ljp/ngt/rtm/entity/train/EntityTrainBase; from L_0000 to L_0030
     .var 1 is world Lnet/minecraft/world/World; from L_0000 to L_0030
     aload 0
     aload 1
     invokespecial jp/ngt/rtm/entity/vehicle/EntityVehicleBase/<init> (Lnet/minecraft/world/World;)V
@@ -101,23 +104,23 @@ L_0011:
     iconst_1
     putfield jp/ngt/rtm/entity/train/EntityTrainBase/onRail Z
 L_0016:
     .line 81
     aload 0
     sipush 2880
     putfield jp/ngt/rtm/entity/train/EntityTrainBase/brakeAirCount I
 L_001b:
     .line 1180
     aload 0
-    new java/util/HashSet
+    new java/util/LinkedHashSet
     dup
-    invokespecial java/util/HashSet/<init> ()V
+    invokespecial java/util/LinkedHashSet/<init> ()V
     putfield jp/ngt/rtm/entity/train/EntityTrainBase/loadedChunks Ljava/util/Set;
 L_0022:
     .line 90
     aload 0
     ldc 2.75f
     ldc 1.1875f
     invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/setSize (FF)V
 L_0028:
     .line 91
     aload 0
@@ -4649,21 +4652,21 @@ L_0000:
     .line 1174
     .var 0 is this Ljp/ngt/rtm/entity/train/EntityTrainBase; from L_0000 to L_0005
     .var 1 is target Lnet/minecraft/util/math/RayTraceResult; from L_0000 to L_0005
     aload 0
     invokestatic jp/ngt/rtm/item/ItemTrain/convertFormationAsItem (Ljp/ngt/rtm/entity/train/EntityTrainBase;)Lnet/minecraft/item/ItemStack;
     areturn
 L_0005:
 .end method
 
 .method private updateChunks ()V
-    .limit stack 2
+    .limit stack 3
     .limit local 1
 L_0000:
     .line 1187
     .var 0 is this Ljp/ngt/rtm/entity/train/EntityTrainBase; from L_0000 to L_001f
     aload 0
     invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/isChunkLoaderEnable ()Z
     ifeq L_000a
 L_0005:
     .line 1189
     aload 0
@@ -4683,20 +4686,28 @@ L_000f:
     aload 0
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/chunkCoordX I
     putfield jp/ngt/rtm/entity/train/EntityTrainBase/prevChunkCoordX I
 L_0016:
     .line 1197
     aload 0
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/chunkCoordZ I
     putfield jp/ngt/rtm/entity/train/EntityTrainBase/prevChunkCoordZ I
+
+    .line 11197
+    aload 0
+    aload 0
+    getstatic jp/ngt/rtm/entity/train/util/TrainState$TrainStateType/ChunkLoader Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;
+    invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/getVehicleState (Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;)B
+    putfield jp/ngt/rtm/entity/train/EntityTrainBase/prevChunkLoaderRadius I
+
 L_001c:
     .line 1198
     return
 L_001f:
 .end method
 
 .method public isChunkLoaderEnable ()Z
     .limit stack 2
     .limit local 1
 L_0000:
@@ -4776,25 +4787,20 @@ L_000c:
     aload 0
     getstatic jp/ngt/rtm/entity/train/util/TrainState$TrainStateType/ChunkLoader Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;
     invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/getVehicleState (Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;)B
     istore 2
 L_0012:
     .line 1222
     .var 2 is depth I from L_0012 to L_002a
     aload 1
     invokevirtual net/minecraftforge/common/ForgeChunkManager$Ticket/getModData ()Lnet/minecraft/nbt/NBTTagCompound;
     pop
-L_0017:
-    .line 1223
-    aload 1
-    iload 2
-    invokevirtual net/minecraftforge/common/ForgeChunkManager$Ticket/setChunkListDepth (I)V
 L_001c:
     .line 1224
     aload 1
     aload 0
     invokevirtual net/minecraftforge/common/ForgeChunkManager$Ticket/bindEntity (Lnet/minecraft/entity/Entity;)V
 L_0021:
     .line 1225
     aload 0
     aload 1
     invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/setChunkTicket (Lnet/minecraftforge/common/ForgeChunkManager$Ticket;)V
@@ -4890,36 +4896,62 @@ L_0007:
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/ticket Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
     ifnonnull L_0011
     aload 0
     invokespecial jp/ngt/rtm/entity/train/EntityTrainBase/requestTicket ()Z
     ifne L_0011
     return
 L_0011:
     .line 1259
     .stack use locals
     .end stack
+
+    aload 0
+    getstatic jp/ngt/rtm/entity/train/util/TrainState$TrainStateType/ChunkLoader Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;
+    invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/getVehicleState (Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;)B
+    aload 0
+    getfield jp/ngt/rtm/entity/train/EntityTrainBase/prevChunkLoaderRadius I
+    if_icmpne L_should_setupChunks
+
     iload 1
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/prevChunkCoordX I
     if_icmpne L_001c
     iload 2
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/prevChunkCoordZ I
     if_icmpeq L_0023
+L_should_setupChunks:
 L_001c:
     .line 1261
     .stack use locals
     .end stack
     aload 0
     iload 1
     iload 2
     invokespecial jp/ngt/rtm/entity/train/EntityTrainBase/setupChunks (II)V
+
+    aload 0
+    getfield jp/ngt/rtm/entity/train/EntityTrainBase/ticket Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
+    aload 0
+    getstatic jp/ngt/rtm/entity/train/util/TrainState$TrainStateType/ChunkLoader Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;
+    invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/getVehicleState (Ljp/ngt/rtm/entity/train/util/TrainState$TrainStateType;)B
+    iconst_2
+    imul
+    iconst_1
+    iadd
+    dup
+    imul
+    ldc "rtm"
+    invokestatic net/minecraftforge/common/ForgeChunkManager/getMaxChunkDepthFor (Ljava/lang/String;)I
+    invokestatic java/lang/Math/min (II)I
+    invokevirtual net/minecraftforge/common/ForgeChunkManager$Ticket/setChunkListDepth (I)V
+
 L_0023:
     .line 1264
     .stack use locals
     .end stack
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/loadedChunks Ljava/util/Set;
     invokeinterface java/util/Set/iterator ()Ljava/util/Iterator;
     astore 3
 L_002a:
     .stack
@@ -4935,20 +4967,27 @@ L_002a:
     invokeinterface java/util/Iterator/next ()Ljava/lang/Object;
     checkcast net/minecraft/util/math/ChunkPos
     astore 4
 L_0033:
     .line 1266
     .var 4 is chunk Lnet/minecraft/util/math/ChunkPos; from L_0033 to L_0039
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/ticket Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
     aload 4
     invokestatic net/minecraftforge/common/ForgeChunkManager/forceChunk (Lnet/minecraftforge/common/ForgeChunkManager$Ticket;Lnet/minecraft/util/math/ChunkPos;)V
+
+    .line 11266
+    aload 0
+    getfield jp/ngt/rtm/entity/train/EntityTrainBase/ticket Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
+    aload 4
+    invokestatic net/minecraftforge/common/ForgeChunkManager/reorderChunk (Lnet/minecraftforge/common/ForgeChunkManager$Ticket;Lnet/minecraft/util/math/ChunkPos;)V
+
 L_0039:
     .line 1268
     goto L_002a
 L_003c:
     .line 1269
     .stack
         locals Object jp/ngt/rtm/entity/train/EntityTrainBase
         locals Integer
         locals Integer
     .end stack
@@ -4958,20 +4997,27 @@ L_003c:
     iload 2
     invokespecial net/minecraft/util/math/ChunkPos/<init> (II)V
     astore 3
 L_0045:
     .line 1270
     .var 3 is myChunk Lnet/minecraft/util/math/ChunkPos; from L_0045 to L_004b
     aload 0
     getfield jp/ngt/rtm/entity/train/EntityTrainBase/ticket Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
     aload 3
     invokestatic net/minecraftforge/common/ForgeChunkManager/forceChunk (Lnet/minecraftforge/common/ForgeChunkManager$Ticket;Lnet/minecraft/util/math/ChunkPos;)V
+
+    .line 11270
+    aload 0
+    getfield jp/ngt/rtm/entity/train/EntityTrainBase/ticket Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
+    aload 3
+    invokestatic net/minecraftforge/common/ForgeChunkManager/reorderChunk (Lnet/minecraftforge/common/ForgeChunkManager$Ticket;Lnet/minecraft/util/math/ChunkPos;)V
+
 L_004b:
     .line 1272
     .stack use locals
     .end stack
     return
 L_004f:
 .end method
 
 .method private setupChunks (II)V
     .limit stack 5
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/train/util/Formation.jasm b/src/main/rtm/jp/ngt/rtm/entity/train/util/Formation.jasm
index 08fdfe9..a7f5e63 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/train/util/Formation.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/train/util/Formation.jasm
@@ -1843,46 +1843,57 @@ L_0000:
     .line 397
     .var 0 is this Ljp/ngt/rtm/entity/train/util/Formation; from L_0000 to L_001f
     .var 1 is train Ljp/ngt/rtm/entity/train/EntityTrainBase; from L_0000 to L_001f
     aload 0
     getfield jp/ngt/rtm/entity/train/util/Formation/direction B
     ifne L_000b
     aload 0
     getfield jp/ngt/rtm/entity/train/util/Formation/entries "[Ljp/ngt/rtm/entity/train/util/FormationEntry;"
     iconst_0
     aaload
-    getfield jp/ngt/rtm/entity/train/util/FormationEntry/train Ljp/ngt/rtm/entity/train/EntityTrainBase;
     goto L_0016
 L_000b:
     .stack
         locals Object jp/ngt/rtm/entity/train/util/Formation
         locals Object jp/ngt/rtm/entity/train/EntityTrainBase
     .end stack
     aload 0
     getfield jp/ngt/rtm/entity/train/util/Formation/entries "[Ljp/ngt/rtm/entity/train/util/FormationEntry;"
     aload 0
     getfield jp/ngt/rtm/entity/train/util/Formation/entries "[Ljp/ngt/rtm/entity/train/util/FormationEntry;"
     arraylength
     iconst_1
     isub
     aaload
-    getfield jp/ngt/rtm/entity/train/util/FormationEntry/train Ljp/ngt/rtm/entity/train/EntityTrainBase;
 L_0016:
     .stack use locals
-        stacks Object jp/ngt/rtm/entity/train/EntityTrainBase
+        stacks Object jp/ngt/rtm/entity/train/util/FormationEntry
     .end stack
     astore 2
 L_0019:
     .line 398
-    .var 2 is front Ljp/ngt/rtm/entity/train/EntityTrainBase; from L_0019 to L_001f
+    .var 2 is front Ljp/ngt/rtm/entity/train/util/FormationEntry; from L_0019 to L_001f
+
+    aload 2
+    ifnonnull L_nonnull
+    iconst_0
+    ireturn
+L_nonnull:
+    .stack
+        locals Object jp/ngt/rtm/entity/train/util/Formation
+        locals Object jp/ngt/rtm/entity/train/EntityTrainBase
+        locals Object jp/ngt/rtm/entity/train/util/FormationEntry
+    .end stack
+
     aload 1
     aload 2
+    getfield jp/ngt/rtm/entity/train/util/FormationEntry/train Ljp/ngt/rtm/entity/train/EntityTrainBase;
     invokevirtual jp/ngt/rtm/entity/train/EntityTrainBase/equals (Ljava/lang/Object;)Z
     ireturn
 L_001f:
 .end method
 
 .method public updateTrainMovement ()V
     .limit stack 5
     .limit local 6
 L_0000:
     .line 404
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/EntityVehicleBase.jasm b/src/main/rtm/jp/ngt/rtm/entity/vehicle/EntityVehicleBase.jasm
index 7ae932e..c99504a 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/EntityVehicleBase.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/vehicle/EntityVehicleBase.jasm
@@ -271,20 +271,22 @@ L_0061:
 L_0068:
     .line 96
     iinc 4 1
     goto L_0058
 L_006c:
     .line 100
     .stack
         locals Object jp/ngt/rtm/entity/vehicle/EntityVehicleBase
         locals Object net/minecraft/world/World
     .end stack
+    aload 0
+    invokestatic com/anatawa12/fixRtm/rtm/entity/vehicle/EntityVehicleBaseKt/constructor (Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase;)V
     return
 L_0070:
 .end method
 
 .method protected entityInit ()V
     .limit stack 0
     .limit local 1
 L_0000:
     .line 105
     .var 0 is this Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase; signature "Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase<TT;>;" from L_0000 to L_0003
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/RenderVehicleBase.jasm b/src/main/rtm/jp/ngt/rtm/entity/vehicle/RenderVehicleBase.jasm
index 5298b6c..b941866 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/RenderVehicleBase.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/vehicle/RenderVehicleBase.jasm
@@ -145,22 +145,22 @@ L_0056:
     .line 69
     .var 18 is roll F from L_0056 to L_00b2
     fload 18
     fconst_0
     fconst_0
     fconst_1
     invokestatic org/lwjgl/opengl/GL11/glRotatef (FFFF)V
 L_005d:
     .line 71
     invokestatic net/minecraft/client/Minecraft/getMinecraft ()Lnet/minecraft/client/Minecraft;
-    getfield net/minecraft/client/Minecraft/gameSettings Lnet/minecraft/client/settings/GameSettings;
-    getfield net/minecraft/client/settings/GameSettings/showDebugInfo Z
+    invokevirtual net/minecraft/client/Minecraft/getRenderManager ()Lnet/minecraft/client/renderer/entity/RenderManager;
+    invokevirtual net/minecraft/client/renderer/entity/RenderManager/isDebugBoundingBox ()Z
     ifeq L_0068
 L_0063:
     .line 73
     aload 0
     aload 1
     invokespecial jp/ngt/rtm/entity/vehicle/RenderVehicleBase/debugCollision (Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase;)V
 L_0068:
     .line 76
     .stack
         locals Object jp/ngt/rtm/entity/vehicle/RenderVehicleBase
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry.jasm b/src/main/rtm/jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry.jasm
index 137db20..730442e 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry.jasm
@@ -616,20 +616,30 @@ L_0051:
     new net/minecraft/network/play/server/SPacketEntityAttach
     dup
     aload 0
     getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
     aload 0
     getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
     invokevirtual net/minecraft/entity/Entity/getRidingEntity ()Lnet/minecraft/entity/Entity;
     invokespecial net/minecraft/network/play/server/SPacketEntityAttach/<init> (Lnet/minecraft/entity/Entity;Lnet/minecraft/entity/Entity;)V
     invokevirtual net/minecraft/network/NetHandlerPlayServer/sendPacket (Lnet/minecraft/network/Packet;)V
 L_005e:
+
+    .stack use locals
+    .end stack
+
+    .line 1195
+    aload 1
+    aload 0
+    getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
+    invokevirtual net/minecraft/entity/player/EntityPlayerMP/addEntity (Lnet/minecraft/entity/Entity;)V
+
     .line 195
     .stack use locals
     .end stack
     aload 0
     getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
     aload 1
     invokestatic net/minecraftforge/event/ForgeEventFactory/onStartEntityTracking (Lnet/minecraft/entity/Entity;Lnet/minecraft/entity/player/EntityPlayer;)V
 L_0065:
     .line 196
     goto L_0083
@@ -665,26 +675,51 @@ L_007d:
     invokestatic net/minecraftforge/event/ForgeEventFactory/onStopEntityTracking (Lnet/minecraft/entity/Entity;Lnet/minecraft/entity/player/EntityPlayer;)V
 L_0083:
     .line 205
     .stack use locals
     .end stack
     return
 L_0087:
 .end method
 
 .method public isVisibleTo (Lnet/minecraft/entity/player/EntityPlayerMP;)Z
-    .limit stack 1
+    .limit stack 4
     .limit local 2
 L_0000:
     .line 210
     .var 0 is this Ljp/ngt/rtm/entity/vehicle/VehicleTrackerEntry; from L_0000 to L_0004
     .var 1 is playerMP Lnet/minecraft/entity/player/EntityPlayerMP; from L_0000 to L_0004
+    aload 1
+    aload 0
+    getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
+    getfield net/minecraft/entity/Entity/posX D
+    aload 0
+    getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
+    getfield net/minecraft/entity/Entity/posY D
+    aload 0
+    getfield jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry/trackedEntity Lnet/minecraft/entity/Entity;
+    getfield net/minecraft/entity/Entity/posZ D
+    invokevirtual net/minecraft/entity/Entity/getDistanceSq (DDD)D
+    ldc 16.0
+    ldc 32.0
+    dmul
+    dup2
+    dmul
+    dcmpl
+    iflt JMP
+    iconst_0
+    ireturn
+JMP:
+    .stack
+        locals Object jp/ngt/rtm/entity/vehicle/VehicleTrackerEntry
+        locals Object net/minecraft/entity/player/EntityPlayerMP
+    .end stack
     iconst_1
     ireturn
 L_0004:
 .end method
 
 .method private isPlayerWatchingThisChunk (Lnet/minecraft/entity/player/EntityPlayerMP;)Z
     .limit stack 4
     .limit local 2
 L_0000:
     .line 215
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/WeatherEffectDummy.jasm b/src/main/rtm/jp/ngt/rtm/entity/vehicle/WeatherEffectDummy.jasm
index d0e484a..b7325e4 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/entity/vehicle/WeatherEffectDummy.jasm
+++ b/src/main/rtm/jp/ngt/rtm/entity/vehicle/WeatherEffectDummy.jasm
@@ -110,22 +110,23 @@ L_002b:
 L_0032:
     .line 36
     aload 0
     aload 0
     getfield jp/ngt/rtm/entity/vehicle/WeatherEffectDummy/parent Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase;
     getfield jp/ngt/rtm/entity/vehicle/EntityVehicleBase/rotationPitch F
     putfield jp/ngt/rtm/entity/vehicle/WeatherEffectDummy/rotationPitch F
 L_0039:
     .line 38
     aload 0
+    aload 0
     getfield jp/ngt/rtm/entity/vehicle/WeatherEffectDummy/parent Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase;
-    getfield jp/ngt/rtm/entity/vehicle/EntityVehicleBase/isDead Z
+    invokestatic com/anatawa12/fixRtm/rtm/entity/vehicle/WeatherEffectDummyKt/shouldDead (Ljp/ngt/rtm/entity/vehicle/WeatherEffectDummy;Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase;)Z
     ifeq L_0050
 L_003f:
     .line 40
     aload 0
     invokevirtual jp/ngt/rtm/entity/vehicle/WeatherEffectDummy/setDead ()V
 L_0043:
     .line 41
     ldc "[WED] Remove %d"
     iconst_1
     anewarray java/lang/Object
@@ -226,10 +227,21 @@ L_0003:
     .limit stack 0
     .limit local 2
 L_0000:
     .line 85
     .var 0 is this Ljp/ngt/rtm/entity/vehicle/WeatherEffectDummy; from L_0000 to L_0003
     .var 1 is compound Lnet/minecraft/nbt/NBTTagCompound; from L_0000 to L_0003
     return
 L_0003:
 .end method
 
+.method public getEntityBoundingBox ()Lnet/minecraft/util/math/AxisAlignedBB;
+    .limit stack 1
+    .limit local 1
+L_start:
+    .var 0 is this Ljp/ngt/rtm/entity/vehicle/WeatherEffectDummy; from L_start to L_end
+    aload 0
+    getfield jp/ngt/rtm/entity/vehicle/WeatherEffectDummy/parent Ljp/ngt/rtm/entity/vehicle/EntityVehicleBase;
+    invokevirtual net/minecraft/entity/Entity/getEntityBoundingBox ()Lnet/minecraft/util/math/AxisAlignedBB;
+    areturn
+L_end:
+.end method
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/event/RTMEventHandler.jasm b/src/main/rtm/jp/ngt/rtm/event/RTMEventHandler.jasm
index aefff78..27c3d26 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/event/RTMEventHandler.jasm
+++ b/src/main/rtm/jp/ngt/rtm/event/RTMEventHandler.jasm
@@ -10,48 +10,62 @@
     .limit local 1
 L_0000:
     .line 18
     .var 0 is this Ljp/ngt/rtm/event/RTMEventHandler; from L_0000 to L_0005
     aload 0
     invokespecial java/lang/Object/<init> ()V
     return
 L_0005:
 .end method
 
-.method public onPlayerLoggedIn (Lnet/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent;)V
+.method public onServerConnectionFromClient (Lnet/minecraftforge/fml/common/network/FMLNetworkEvent$ServerConnectionFromClientEvent;)V
     .annotation visible net/minecraftforge/fml/common/eventhandler/SubscribeEvent
     .end annotation
     .limit stack 2
     .limit local 2
 L_0000:
     .line 26
     .var 0 is this Ljp/ngt/rtm/event/RTMEventHandler; from L_0000 to L_001e
-    .var 1 is event Lnet/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent; from L_0000 to L_001e
+    .var 1 is event Lnet/minecraftforge/fml/common/network/FMLNetworkEvent$ServerConnectionFromClientEvent; from L_0000 to L_001e
     invokestatic jp/ngt/ngtlib/util/NGTUtil/isSMP ()Z
     ifne L_0006
     invokestatic jp/ngt/ngtlib/util/NGTUtil/openedLANWorld ()Z
     ifeq L_000e
 L_0006:
     .line 28
     .stack
         locals Object jp/ngt/rtm/event/RTMEventHandler
-        locals Object net/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent
+        locals Object net/minecraftforge/fml/common/network/FMLNetworkEvent$ServerConnectionFromClientEvent
     .end stack
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 1
-    getfield net/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent/player Lnet/minecraft/entity/player/EntityPlayer;
-    checkcast net/minecraft/entity/player/EntityPlayerMP
+    invokevirtual net/minecraftforge/fml/common/network/FMLNetworkEvent$ServerConnectionFromClientEvent/getHandler ()Lnet/minecraft/network/INetHandler;
+    checkcast net/minecraft/network/NetHandlerPlayServer
+    getfield net/minecraft/network/NetHandlerPlayServer/player Lnet/minecraft/entity/player/EntityPlayerMP;
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/sendModelSetsToClient (Lnet/minecraft/entity/player/EntityPlayerMP;)V
 L_000e:
     .line 30
     .stack use locals
     .end stack
+    return
+L_001e:
+.end method
+
+.method public onPlayerLoggedIn (Lnet/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent;)V
+    .annotation visible net/minecraftforge/fml/common/eventhandler/SubscribeEvent
+    .end annotation
+    .limit stack 2
+    .limit local 2
+L_0000:
+    .var 0 is this Ljp/ngt/rtm/event/RTMEventHandler; from L_0000 to L_001e
+    .var 1 is event Lnet/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent; from L_0000 to L_001e
+    .line 30
     getstatic jp/ngt/rtm/block/decoration/DecorationStore/INSTANCE Ljp/ngt/rtm/block/decoration/DecorationStore;
     aload 1
     getfield net/minecraftforge/fml/common/gameevent/PlayerEvent$PlayerLoggedInEvent/player Lnet/minecraft/entity/player/EntityPlayer;
     invokevirtual net/minecraft/entity/player/EntityPlayer/getEntityWorld ()Lnet/minecraft/world/World;
     invokevirtual jp/ngt/rtm/block/decoration/DecorationStore/loadModels (Lnet/minecraft/world/World;)V
 L_0016:
     .line 31
     iconst_1
     invokestatic jp/ngt/rtm/sound/SpeakerSounds/getInstance (Z)Ljp/ngt/rtm/sound/SpeakerSounds;
     invokevirtual jp/ngt/rtm/sound/SpeakerSounds/syncSoundList ()V
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/ModelPackManager.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/ModelPackManager.jasm
index 79fab25..8c22920 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/ModelPackManager.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/ModelPackManager.jasm
@@ -12,29 +12,29 @@
 .field private static final SC_INCLUDE Ljava/util/regex/Pattern;
 .end field
 
 .field private static final ENCODING "[Ljava/lang/String;"
 .end field
 
 .field private final typeMap Ljava/util/Map;
     .signature "Ljava/util/Map<Ljava/lang/String;Ljp/ngt/rtm/modelpack/ResourceType;>;"
 .end field
 
-.field private final allModelSetMap Ljava/util/Map;
+.field public final allModelSetMap Ljava/util/Map;
     .signature "Ljava/util/Map<Ljp/ngt/rtm/modelpack/ResourceType;Ljava/util/Map<Ljava/lang/String;Ljp/ngt/rtm/modelpack/modelset/ResourceSet;>;>;"
 .end field
 
 .field private final smpModelSetMap Ljava/util/Map;
     .signature "Ljava/util/Map<Ljp/ngt/rtm/modelpack/ResourceType;Ljava/util/Map<Ljava/lang/String;Ljp/ngt/rtm/modelpack/modelset/ResourceSet;>;>;"
 .end field
 
-.field private final dummyMap Ljava/util/Map;
+.field public final dummyMap Ljava/util/Map;
     .signature "Ljava/util/Map<Ljava/lang/String;Ljp/ngt/rtm/modelpack/modelset/ResourceSet;>;"
 .end field
 
 .field public final unconstructSets Ljava/util/List;
     .signature "Ljava/util/List<Ljp/ngt/rtm/modelpack/modelset/ResourceSet;>;"
 .end field
 
 .field private final modelCache Ljava/util/Map;
     .signature "Ljava/util/Map<Ljava/lang/String;Ljp/ngt/ngtlib/renderer/model/IModelNGT;>;"
 .end field
@@ -472,20 +472,26 @@ L_00ec:
     aload 8
     invokevirtual jp/ngt/rtm/modelpack/init/ModelPackLoadThread/setBarValue (IILjava/lang/String;)V
 L_00f3:
     .line 146
     new jp/ngt/rtm/modelpack/cfg/RRSConfig
     dup
     aload 8
     invokespecial jp/ngt/rtm/modelpack/cfg/RRSConfig/<init> (Ljava/lang/String;)V
     astore 9
 L_00fa:
+
+    .line 1218
+    aload 9
+    aload 7
+    putfield jp/ngt/rtm/modelpack/cfg/ResourceConfig/file Ljava/io/File;
+
     .line 147
     .var 9 is cfg Ljp/ngt/rtm/modelpack/cfg/RRSConfig; from L_00fa to L_0102
     aload 0
     getstatic jp/ngt/rtm/RTMResource/RRS Ljp/ngt/rtm/modelpack/ResourceType;
     aload 9
     ldc "dummy_str"
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/registerResourceSet (Ljp/ngt/rtm/modelpack/ResourceType;Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;Ljava/lang/String;)Ljava/lang/String;
     pop
 L_0102:
     .line 148
@@ -701,20 +707,26 @@ L_0012:
 L_0019:
     .line 218
     .var 7 is json Ljava/lang/String; from L_0019 to L_002a
     aload 7
     aload 1
     getfield jp/ngt/rtm/modelpack/ResourceType/cfgClass Ljava/lang/Class;
     invokestatic jp/ngt/ngtlib/io/NGTJson/getObjectFromJson (Ljava/lang/String;Ljava/lang/Class;)Ljava/lang/Object;
     checkcast jp/ngt/rtm/modelpack/cfg/ResourceConfig
     astore 8
 L_0021:
+
+    .line 1218
+    aload 8
+    aload 2
+    putfield jp/ngt/rtm/modelpack/cfg/ResourceConfig/file Ljava/io/File;
+
     .line 219
     .var 8 is cfg Ljp/ngt/rtm/modelpack/cfg/ResourceConfig; from L_0021 to L_002a
     aload 0
     aload 1
     aload 8
     aload 7
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/registerResourceSet (Ljp/ngt/rtm/modelpack/ResourceType;Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;Ljava/lang/String;)Ljava/lang/String;
 L_0028:
     areturn
 L_002a:
@@ -799,21 +811,39 @@ L_001b:
     dup
     iconst_0
     aload 2
     invokevirtual jp/ngt/rtm/modelpack/cfg/ResourceConfig/getName ()Ljava/lang/String;
     aastore
     dup
     iconst_1
     aload 1
     getfield jp/ngt/rtm/modelpack/ResourceType/name Ljava/lang/String;
     aastore
+
+    ldc "for_decompiler_cup"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/never (Ljava/lang/String;)V
+
+    dup2
+
+    ldc "reduceConstructModelLog"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
     invokestatic jp/ngt/ngtlib/io/NGTLog/debug "(Ljava/lang/String;[Ljava/lang/Object;)V"
+
+    ldc "reduceConstructModelLog"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    invokestatic jp/ngt/ngtlib/io/NGTLog/trace "(Ljava/lang/String;[Ljava/lang/Object;)V"
+
+    ldc "reduceConstructModelLog"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
 L_002b:
     .line 236
     aload 0
     getfield jp/ngt/rtm/modelpack/ModelPackManager/allModelSetMap Ljava/util/Map;
     aload 1
     invokeinterface java/util/Map/get (Ljava/lang/Object;)Ljava/lang/Object;
     checkcast java/util/Map
     aload 2
     invokevirtual jp/ngt/rtm/modelpack/cfg/ResourceConfig/getName ()Ljava/lang/String;
     aload 4
@@ -956,26 +986,34 @@ L_0048:
 L_004b:
     .line 260
     .stack
         locals Object jp/ngt/rtm/modelpack/ModelPackManager
         locals Object net/minecraft/entity/player/EntityPlayerMP
         locals Integer
         locals Object java/util/Iterator
     .end stack
     goto L_000b
 L_004f:
-    .line 261
+    .line 1261
     .stack
         locals Object jp/ngt/rtm/modelpack/ModelPackManager
         locals Object net/minecraft/entity/player/EntityPlayerMP
         locals Integer
     .end stack
+
+    new com/anatawa12/fixRtm/network/SentAllModels
+    dup
+    invokespecial com/anatawa12/fixRtm/network/SentAllModels/<init> ()V
+    aload 1
+    invokestatic com/anatawa12/fixRtm/network/NetworkHandler/sendPacketEPM (Lnet/minecraftforge/fml/common/network/simpleimpl/IMessage;Lnet/minecraft/entity/player/EntityPlayerMP;)V
+
+    .line 261
     return
 L_0053:
 .end method
 
 .method public addModelSetName (ILjava/lang/String;Ljava/lang/String;)V
     .limit stack 3
     .limit local 6
 L_0000:
     .line 266
     .var 0 is this Ljp/ngt/rtm/modelpack/ModelPackManager; from L_0000 to L_0068
@@ -1190,20 +1228,21 @@ L_002e:
 .method public getResourceSet (Ljp/ngt/rtm/modelpack/ResourceType;Ljava/lang/String;)Ljp/ngt/rtm/modelpack/modelset/ResourceSet;
     .signature "<T:Ljp/ngt/rtm/modelpack/modelset/ResourceSet;>(Ljp/ngt/rtm/modelpack/ResourceType;Ljava/lang/String;)TT;"
     .limit stack 4
     .limit local 7
 L_0000:
     .line 310
     .var 0 is this Ljp/ngt/rtm/modelpack/ModelPackManager; from L_0000 to L_005d
     .var 1 is type Ljp/ngt/rtm/modelpack/ResourceType; from L_0000 to L_005d
     .var 2 is name Ljava/lang/String; from L_0000 to L_005d
     aload 1
+    invokestatic jp/ngt/rtm/modelpack/ModelPackManager/"get parent or me" (Ljp/ngt/rtm/modelpack/ResourceType;)Ljp/ngt/rtm/modelpack/ResourceType;
     astore 3
 L_0004:
     .line 311
     .var 3 is parent Ljp/ngt/rtm/modelpack/ResourceType; from L_0004 to L_005d
     aload 1
     getfield jp/ngt/rtm/modelpack/ResourceType/parent Ljp/ngt/rtm/modelpack/ResourceType;
     ifnull L_000e
 L_0009:
     .line 313
     aload 1
@@ -1266,64 +1305,34 @@ L_002b:
     invokeinterface java/util/Map/get (Ljava/lang/Object;)Ljava/lang/Object;
     checkcast jp/ngt/rtm/modelpack/modelset/ResourceSet
     astore 6
 L_0035:
     .line 319
     .var 6 is modelSet Ljp/ngt/rtm/modelpack/modelset/ResourceSet; signature "TT;" from L_0035 to L_005d
     aload 6
     ifnonnull L_0058
 L_0039:
     .line 321
-    aload 0
-    getfield jp/ngt/rtm/modelpack/ModelPackManager/dummyMap Ljava/util/Map;
-    aload 1
-    getfield jp/ngt/rtm/modelpack/ResourceType/hasSubType Z
-    ifeq L_0043
     aload 1
-    getfield jp/ngt/rtm/modelpack/ResourceType/subType Ljava/lang/String;
-    goto L_0047
-L_0043:
+    aload 2
+    invokestatic com/anatawa12/fixRtm/DummyModelPackManager/getSet (Ljp/ngt/rtm/modelpack/ResourceType;Ljava/lang/String;)Ljp/ngt/rtm/modelpack/modelset/ResourceSet;
+    areturn
+L_0058:
+    .line 327
     .stack
         locals Object jp/ngt/rtm/modelpack/ModelPackManager
         locals Object jp/ngt/rtm/modelpack/ResourceType
         locals Object java/lang/String
         locals Object jp/ngt/rtm/modelpack/ResourceType
         locals Integer
         locals Object java/util/Map
         locals Object jp/ngt/rtm/modelpack/modelset/ResourceSet
-        stacks Object java/util/Map
-    .end stack
-    aload 1
-    getfield jp/ngt/rtm/modelpack/ResourceType/name Ljava/lang/String;
-L_0047:
-    .stack use locals
-        stacks Object java/util/Map
-        stacks Object java/lang/Object
-    .end stack
-    invokeinterface java/util/Map/get (Ljava/lang/Object;)Ljava/lang/Object;
-    checkcast jp/ngt/rtm/modelpack/modelset/ResourceSet
-    astore 6
-L_004c:
-    .line 322
-    aload 6
-    ifnonnull L_0058
-L_0050:
-    .line 324
-    new jp/ngt/rtm/modelpack/ModelPackException
-    dup
-    ldc "Default model is not registered."
-    aload 2
-    invokespecial jp/ngt/rtm/modelpack/ModelPackException/<init> (Ljava/lang/String;Ljava/lang/String;)V
-    athrow
-L_0058:
-    .line 327
-    .stack use locals
     .end stack
     aload 6
     areturn
 L_005d:
 .end method
 
 .method public getModelList (Ljp/ngt/rtm/modelpack/ResourceType;)Ljava/util/List;
     .signature "(Ljp/ngt/rtm/modelpack/ResourceType;)Ljava/util/List<Ljp/ngt/rtm/modelpack/modelset/ResourceSet;>;"
     .limit stack 3
     .limit local 4
@@ -2093,10 +2102,31 @@ L_0018:
     ldc "UTF-8"
     aastore
     dup
     iconst_1
     ldc "SJIS"
     aastore
     putstatic jp/ngt/rtm/modelpack/ModelPackManager/ENCODING "[Ljava/lang/String;"
     return
 .end method
 
+.method public static "get parent or me" "(Ljp/ngt/rtm/modelpack/ResourceType;)Ljp/ngt/rtm/modelpack/ResourceType;"
+    .limit local 1
+    .limit stack 1
+
+    .stack
+        locals Object jp/ngt/rtm/modelpack/ResourceType
+    .end stack
+    aload 0
+    getfield jp/ngt/rtm/modelpack/ResourceType/parent Ljp/ngt/rtm/modelpack/ResourceType;
+    ifnull L_if_null_to
+    .stack use locals
+    .end stack
+    aload 0
+    getfield jp/ngt/rtm/modelpack/ResourceType/parent Ljp/ngt/rtm/modelpack/ResourceType;
+    areturn
+L_if_null_to:
+    .stack use locals
+    .end stack
+    aload 0
+    areturn
+.end method
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/cfg/ResourceConfig.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/cfg/ResourceConfig.jasm
index 1ae0f4c..622f680 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/cfg/ResourceConfig.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/cfg/ResourceConfig.jasm
@@ -9,20 +9,23 @@
 
 .field public useCustomColor Z
 .end field
 
 .field public tags Ljava/lang/String;
 .end field
 
 .field public defaultValues "[Ljp/ngt/rtm/modelpack/cfg/ResourceConfig\$DMInitValue;"
 .end field
 
+.field public file Ljava/io/File;
+.end field
+
 .field public defaultData Ljava/lang/String;
     .annotation visible java/lang/Deprecated
     .end annotation
 .end field
 
 .method public <init> ()V
     .limit stack 1
     .limit local 1
 L_0000:
     .line 6
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/init/ModelPackConstructThread.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/init/ModelPackConstructThread.jasm
index 09bef39..c998070 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/init/ModelPackConstructThread.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/init/ModelPackConstructThread.jasm
@@ -1,13 +1,13 @@
 .bytecode 52.0
 .source "ModelPackConstructThread.java"
-.class public final jp/ngt/rtm/modelpack/init/ModelPackConstructThread
+.class public jp/ngt/rtm/modelpack/init/ModelPackConstructThread
 .super java/lang/Thread
 .inner public static final enum jp/ngt/rtm/modelpack/init/ProgressStateHolder$ProgressState inner ProgressState outer jp/ngt/rtm/modelpack/init/ProgressStateHolder
 
 .field private final threadSide Lnet/minecraftforge/fml/relauncher/Side;
 .end field
 
 .field private final parent Ljp/ngt/rtm/modelpack/init/ModelPackLoadThread;
 .end field
 
 .field private loading Z
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/init/ModelPackLoadThread.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/init/ModelPackLoadThread.jasm
index 0a49c17..d210f43 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/init/ModelPackLoadThread.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/init/ModelPackLoadThread.jasm
@@ -547,45 +547,45 @@ L_0035:
     iconst_0
     invokestatic jp/ngt/rtm/modelpack/init/ProgressStateHolder$ProgressState/values "()[Ljp/ngt/rtm/modelpack/init/ProgressStateHolder\$ProgressState;"
     arraylength
     ldc ""
     invokevirtual jp/ngt/rtm/modelpack/init/ModelPackLoadThread/setBarMaxValue (IILjava/lang/String;)V
 L_003e:
     .line 184
     invokestatic jp/ngt/ngtlib/io/NGTLog/startTimer ()V
 L_0041:
     .line 185
-    new jp/ngt/rtm/modelpack/init/ModelPackConstructThread
+    new com/anatawa12/fixRtm/rtm/modelpack/init/ExModelPackConstructThread
     dup
     aload 0
     getfield jp/ngt/rtm/modelpack/init/ModelPackLoadThread/threadSide Lnet/minecraftforge/fml/relauncher/Side;
     aload 0
-    invokespecial jp/ngt/rtm/modelpack/init/ModelPackConstructThread/<init> (Lnet/minecraftforge/fml/relauncher/Side;Ljp/ngt/rtm/modelpack/init/ModelPackLoadThread;)V
+    invokespecial com/anatawa12/fixRtm/rtm/modelpack/init/ExModelPackConstructThread/<init> (Lnet/minecraftforge/fml/relauncher/Side;Ljp/ngt/rtm/modelpack/init/ModelPackLoadThread;)V
     astore 1
 L_004a:
     .line 186
-    .var 1 is thread2 Ljp/ngt/rtm/modelpack/init/ModelPackConstructThread; from L_004a to L_006a
+    .var 1 is thread2 Lcom/anatawa12/fixRtm/rtm/modelpack/init/ExModelPackConstructThread; from L_004a to L_006a
     aload 1
-    invokevirtual jp/ngt/rtm/modelpack/init/ModelPackConstructThread/start ()V
+    invokevirtual com/anatawa12/fixRtm/rtm/modelpack/init/ExModelPackConstructThread/start ()V
 L_004e:
     .line 187
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/load (Ljp/ngt/rtm/modelpack/init/ModelPackLoadThread;)V
 L_0053:
     .line 188
     .stack
         locals Object jp/ngt/rtm/modelpack/init/ModelPackLoadThread
-        locals Object jp/ngt/rtm/modelpack/init/ModelPackConstructThread
+        locals Object com/anatawa12/fixRtm/rtm/modelpack/init/ExModelPackConstructThread
     .end stack
     aload 1
-    invokevirtual jp/ngt/rtm/modelpack/init/ModelPackConstructThread/setFinish ()Z
+    invokevirtual com/anatawa12/fixRtm/rtm/modelpack/init/ExModelPackConstructThread/setFinish ()Z
     ifne L_005e
 L_0059:
     .line 190
     ldc 500L
     invokestatic jp/ngt/rtm/modelpack/init/ModelPackLoadThread/sleep (J)V
     goto L_0053
 L_005e:
     .line 192
     .stack use locals
     .end stack
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/modelset/ModelSetBase.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/modelset/ModelSetBase.jasm
index c1621a2..ef1f288 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/modelset/ModelSetBase.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/modelset/ModelSetBase.jasm
@@ -80,22 +80,35 @@ L_0000:
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/serverScriptPath Ljava/lang/String;
     ifnull L_0012
 L_0007:
     .line 48
     aload 0
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     getfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/cfg Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;
     checkcast jp/ngt/rtm/modelpack/cfg/ModelConfig
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/serverScriptPath Ljava/lang/String;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getScript (Ljava/lang/String;)Ljava/lang/String;
     invokestatic jp/ngt/ngtlib/io/ScriptUtil/doScript (Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    invokestatic com/anatawa12/fixRtm/scripting/FIXScriptUtil/getScriptAndDoScript (Ljp/ngt/rtm/modelpack/ModelPackManager;Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
     putfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/serverSE Ljavax/script/ScriptEngine;
 L_0012:
     .line 50
     .stack
         locals Object jp/ngt/rtm/modelpack/modelset/ModelSetBase
     .end stack
     return
 L_0016:
 .end method
 
@@ -119,43 +132,69 @@ L_0005:
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/serverScriptPath Ljava/lang/String;
     ifnull L_0017
 L_000c:
     .line 61
     aload 0
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     getfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/cfg Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;
     checkcast jp/ngt/rtm/modelpack/cfg/ModelConfig
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/serverScriptPath Ljava/lang/String;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getScript (Ljava/lang/String;)Ljava/lang/String;
     invokestatic jp/ngt/ngtlib/io/ScriptUtil/doScript (Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    invokestatic com/anatawa12/fixRtm/scripting/FIXScriptUtil/getScriptAndDoScript (Ljp/ngt/rtm/modelpack/ModelPackManager;Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
     putfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/serverSE Ljavax/script/ScriptEngine;
 L_0017:
     .line 64
     .stack
         locals Object jp/ngt/rtm/modelpack/modelset/ModelSetBase
     .end stack
     aload 0
     getfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/cfg Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;
     checkcast jp/ngt/rtm/modelpack/cfg/ModelConfig
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/guiScriptPath Ljava/lang/String;
     ifnull L_0034
 L_001f:
     .line 66
     aload 0
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     getfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/cfg Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;
     checkcast jp/ngt/rtm/modelpack/cfg/ModelConfig
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/guiScriptPath Ljava/lang/String;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getScript (Ljava/lang/String;)Ljava/lang/String;
     invokestatic jp/ngt/ngtlib/io/ScriptUtil/doScript (Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    invokestatic com/anatawa12/fixRtm/scripting/FIXScriptUtil/getScriptAndDoScript (Ljp/ngt/rtm/modelpack/ModelPackManager;Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
     putfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/guiSE Ljavax/script/ScriptEngine;
 L_002a:
     .line 67
     aload 0
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     getfield jp/ngt/rtm/modelpack/modelset/ModelSetBase/cfg Ljp/ngt/rtm/modelpack/cfg/ResourceConfig;
     checkcast jp/ngt/rtm/modelpack/cfg/ModelConfig
     getfield jp/ngt/rtm/modelpack/cfg/ModelConfig/guiTexture Ljava/lang/String;
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getResource (Ljava/lang/String;)Lnet/minecraft/util/ResourceLocation;
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase.jasm
index e05f400..1418cc5 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase.jasm
@@ -192,22 +192,35 @@ L_0068:
     checkcast jp/ngt/rtm/modelpack/cfg/VehicleBaseConfig
     getfield jp/ngt/rtm/modelpack/cfg/VehicleBaseConfig/soundScriptPath Ljava/lang/String;
     ifnull L_0079
 L_006f:
     .line 62
     aload 0
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     invokevirtual jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase/getConfig ()Ljp/ngt/rtm/modelpack/cfg/VehicleBaseConfig;
     getfield jp/ngt/rtm/modelpack/cfg/VehicleBaseConfig/soundScriptPath Ljava/lang/String;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getScript (Ljava/lang/String;)Ljava/lang/String;
     invokestatic jp/ngt/ngtlib/io/ScriptUtil/doScript (Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    invokestatic com/anatawa12/fixRtm/scripting/FIXScriptUtil/getScriptAndDoScript (Ljp/ngt/rtm/modelpack/ModelPackManager;Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
     putfield jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase/soundSE Ljavax/script/ScriptEngine;
 L_0079:
     .line 65
     .stack
         locals Object jp/ngt/rtm/modelpack/modelset/ModelSetVehicleBase
     .end stack
     return
 L_007d:
 .end method
 
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/state/ResourceState.jasm b/src/main/rtm/jp/ngt/rtm/modelpack/state/ResourceState.jasm
index 05b0fa4..e80bd03 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/modelpack/state/ResourceState.jasm
+++ b/src/main/rtm/jp/ngt/rtm/modelpack/state/ResourceState.jasm
@@ -350,20 +350,23 @@ L_0009:
     .stack
         locals Object jp/ngt/rtm/modelpack/state/ResourceState
     .end stack
     aload 0
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     getfield jp/ngt/rtm/modelpack/state/ResourceState/type Ljp/ngt/rtm/modelpack/ResourceType;
     aload 0
     getfield jp/ngt/rtm/modelpack/state/ResourceState/modelName Ljava/lang/String;
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getResourceSet (Ljp/ngt/rtm/modelpack/ResourceType;Ljava/lang/String;)Ljp/ngt/rtm/modelpack/modelset/ResourceSet;
+    aload 0
+    getfield jp/ngt/rtm/modelpack/state/ResourceState/type Ljp/ngt/rtm/modelpack/ResourceType;
+    invokestatic com/anatawa12/fixRtm/rtm/HooksKt/eraseNullForModelSet (Ljp/ngt/rtm/modelpack/modelset/ResourceSet;Ljp/ngt/rtm/modelpack/ResourceType;)Ljp/ngt/rtm/modelpack/modelset/ResourceSet;
     putfield jp/ngt/rtm/modelpack/state/ResourceState/modelSet Ljp/ngt/rtm/modelpack/modelset/ResourceSet;
 L_0014:
     .line 118
     aload 0
     getfield jp/ngt/rtm/modelpack/state/ResourceState/modelSet Ljp/ngt/rtm/modelpack/modelset/ResourceSet;
     invokevirtual jp/ngt/rtm/modelpack/modelset/ResourceSet/isDummy ()Z
     ifne L_0022
 L_001a:
     .line 120
     aload 0
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/network/PacketVehicleMovement.jasm b/src/main/rtm/jp/ngt/rtm/network/PacketVehicleMovement.jasm
index 6e5c39c..e670ca1 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/network/PacketVehicleMovement.jasm
+++ b/src/main/rtm/jp/ngt/rtm/network/PacketVehicleMovement.jasm
@@ -357,20 +357,24 @@ L_001b:
 L_0023:
     .line 97
     .var 4 is entity Lnet/minecraft/entity/Entity; from L_0023 to L_008e
     aload 4
     ifnull L_007c
     aload 4
     getfield net/minecraft/entity/Entity/isDead Z
     ifne L_007c
 L_002a:
     .line 99
+
+    aload 4
+    invokestatic com/anatawa12/fixRtm/rtm/network/PacketVehicleMovementKt/addEntityIfNotExits (Lnet/minecraft/entity/Entity;)V
+
     aload 1
     getfield jp/ngt/rtm/network/PacketVehicleMovement/vehicleX I
     i2d
     ldc 0.03125
     dmul
     dstore 5
 L_0032:
     .line 100
     .var 5 is x D from L_0032 to L_0078
     aload 1
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/BlockMarker.jasm b/src/main/rtm/jp/ngt/rtm/rail/BlockMarker.jasm
index aa59bb1..c959d84 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/BlockMarker.jasm
+++ b/src/main/rtm/jp/ngt/rtm/rail/BlockMarker.jasm
@@ -527,20 +527,22 @@ L_000f:
     .limit local 12
 L_0000:
     .line 169
     .var 0 is this Ljp/ngt/rtm/rail/BlockMarker; from L_0000 to L_0052
     .var 1 is world Lnet/minecraft/world/World; from L_0000 to L_0052
     .var 2 is x I from L_0000 to L_0052
     .var 3 is y I from L_0000 to L_0052
     .var 4 is z I from L_0000 to L_0052
     .var 5 is player Lnet/minecraft/entity/player/EntityPlayer; from L_0000 to L_0052
     .var 6 is makeRail Z from L_0000 to L_0052
+    aload 5
+    invokestatic com/anatawa12/fixRtm/rtm/HooksKt/BlockMarker_onMarkerActivated "(Lnet/minecraft/entity/player/EntityPlayer;)V"
     aload 0
     aload 5
     iload 6
     invokevirtual jp/ngt/rtm/rail/BlockMarker/hasRail (Lnet/minecraft/entity/player/EntityPlayer;Z)Ljp/ngt/rtm/modelpack/state/ResourceStateRail;
     astore 7
 L_0007:
     .line 170
     .var 7 is prop Ljp/ngt/rtm/modelpack/state/ResourceStateRail; from L_0007 to L_0052
     aload 7
     ifnull L_004d
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/RenderMarkerBlock.jasm b/src/main/rtm/jp/ngt/rtm/rail/RenderMarkerBlock.jasm
index 14eaa94..bd54e73 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/RenderMarkerBlock.jasm
+++ b/src/main/rtm/jp/ngt/rtm/rail/RenderMarkerBlock.jasm
@@ -963,22 +963,26 @@ L_005c:
     iconst_1
     if_icmpgt L_0098
 L_0061:
     .line 212
     fload 9
     iload 10
     i2f
     fmul
     fstore 11
 L_0068:
-    .line 213
     .var 11 is moveX F from L_0068 to L_0094
+
+    ldc "markerDistanceMoreRealPosition"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
+    .line 213
     aload 7
     ldc -0.4f
     fload 11
     fadd
     fconst_0
     ldc 0.4f
     fload 9
     fadd
     invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
 L_0073:
@@ -1007,20 +1011,109 @@ L_0089:
     .line 216
     aload 7
     ldc 0.4f
     fload 11
     fadd
     fconst_0
     ldc 0.4f
     fload 9
     fadd
     invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+
+    ldc "markerDistanceMoreRealPosition"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    .line 1213
+    aload 7
+    ldc -0.4f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.4f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+    .line 1214
+    aload 7
+    ldc -0.4f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.6f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+    .line 1215
+    aload 7
+    ldc 0.4f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.6f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+    .line 1216
+    aload 7
+    ldc 0.4f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.4f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+
+    .line 1217
+    aload 7
+    ldc -0.1f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.1f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+    .line 1218
+    aload 7
+    ldc -0.1f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.9f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+    .line 1219
+    aload 7
+    ldc 0.1f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.9f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+    .line 1220
+    aload 7
+    ldc 0.1f
+    fload 11
+    fadd
+    fconst_0
+    ldc -0.1f
+    fload 9
+    fadd
+    invokevirtual jp/ngt/ngtlib/renderer/NGTTessellator/addVertex (FFF)V
+
+    ldc ""
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
 L_0094:
     .line 210
     iinc 10 1
     goto L_005c
 L_0098:
     .line 207
     .stack
         locals Object jp/ngt/rtm/rail/RenderMarkerBlock
         locals Object jp/ngt/rtm/rail/TileEntityMarker
         locals Integer
@@ -1124,20 +1217,28 @@ L_00ca:
     fstore 12
 L_00d1:
     .line 229
     .var 12 is moveX F from L_00d1 to L_010a
     invokestatic org/lwjgl/opengl/GL11/glPushMatrix ()V
 L_00d4:
     .line 230
     fload 12
     fconst_0
     fload 10
+
+    ldc "markerDistanceMoreRealPosition"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+    ldc -0.5f
+    fadd
+    ldc ""
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
     invokestatic org/lwjgl/opengl/GL11/glTranslatef (FFF)V
 L_00da:
     .line 231
     invokestatic jp/ngt/ngtlib/util/NGTUtilClient/getMinecraft ()Lnet/minecraft/client/Minecraft;
     invokevirtual net/minecraft/client/Minecraft/getRenderManager ()Lnet/minecraft/client/renderer/entity/RenderManager;
     getfield net/minecraft/client/renderer/entity/RenderManager/playerViewY F
     fneg
     fload 5
     fsub
     fconst_0
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/util/RailMaker.jasm b/src/main/rtm/jp/ngt/rtm/rail/util/RailMaker.jasm
index 9f15efb..380b0e5 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/util/RailMaker.jasm
+++ b/src/main/rtm/jp/ngt/rtm/rail/util/RailMaker.jasm
@@ -509,20 +509,20 @@ L_005a:
     aload 2
     getfield jp/ngt/rtm/rail/util/RailPosition/blockY I
     invokestatic java/lang/Integer/valueOf (I)Ljava/lang/Integer;
     aastore
     dup
     iconst_2
     aload 2
     getfield jp/ngt/rtm/rail/util/RailPosition/blockZ I
     invokestatic java/lang/Integer/valueOf (I)Ljava/lang/Integer;
     aastore
-    invokestatic jp/ngt/ngtlib/io/NGTLog/sendChatMessageToAll "(Ljava/lang/String;[Ljava/lang/Object;)V"
+    invokestatic com/anatawa12/fixRtm/rtm/HooksKt/sendSwitchTypeError "(Ljava/lang/String;[Ljava/lang/Object;)V"
 L_0072:
     .line 101
     .stack use locals
     .end stack
     aconst_null
     areturn
 L_0077:
 .end method
 
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/util/SwitchType$SwitchSingleCross.jasm b/src/main/rtm/jp/ngt/rtm/rail/util/SwitchType$SwitchSingleCross.jasm
index d1831ec..7eeb299 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/rail/util/SwitchType$SwitchSingleCross.jasm
+++ b/src/main/rtm/jp/ngt/rtm/rail/util/SwitchType$SwitchSingleCross.jasm
@@ -290,20 +290,30 @@ L_0089:
     aload 3
     iconst_2
     new jp/ngt/rtm/rail/util/RailMapSwitch
     dup
     aload 4
     aload 5
     aload 6
     aload 7
     invokespecial jp/ngt/rtm/rail/util/RailMapSwitch/<init> (Ljp/ngt/rtm/rail/util/RailPosition;Ljp/ngt/rtm/rail/util/RailPosition;Ljp/ngt/rtm/rail/util/RailDir;Ljp/ngt/rtm/rail/util/RailDir;)V
     aastore
+
+    aload 3
+    invokestatic com/anatawa12/fixRtm/UtilsKt/isAllNotNull ([Ljava/lang/Object;)Z
+    ifne L_all_railMaps_are_not_null
+    iconst_0
+    ireturn
+L_all_railMaps_are_not_null:
+    .stack use locals
+    .end stack
+
 L_0096:
     .line 172
     aload 0
     aload 3
     putfield jp/ngt/rtm/rail/util/SwitchType$SwitchSingleCross/railMaps "[Ljp/ngt/rtm/rail/util/RailMapSwitch;"
 L_009b:
     .line 174
     aload 0
     iconst_4
     anewarray jp/ngt/rtm/rail/util/Point
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/render/ModelObject.jasm b/src/main/rtm/jp/ngt/rtm/render/ModelObject.jasm
index 43af393..9336590 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/render/ModelObject.jasm
+++ b/src/main/rtm/jp/ngt/rtm/render/ModelObject.jasm
@@ -605,20 +605,52 @@ L_001d:
     iconst_0
     anewarray java/lang/Object
     invokespecial jp/ngt/rtm/render/ModelObject/getPartsRenderer "(Ljava/lang/String;Ljp/ngt/ngtlib/renderer/model/IModelNGT;[Ljava/lang/Object;)Ljp/ngt/rtm/render/PartsRenderer;"
     putfield jp/ngt/rtm/render/ModelObject/renderer Ljp/ngt/rtm/render/PartsRenderer;
 L_0027:
     .line 122
     return
 L_002a:
 .end method
 
+.method public <init> "(Ljp/ngt/ngtlib/renderer/model/IModelNGT;[Ljp/ngt/ngtlib/renderer/model/TextureSet;Ljp/ngt/rtm/render/PartsRenderer;)V"
+    .limit stack 5
+    .limit local 4
+L_start:
+    .var 0 is this Ljp/ngt/rtm/render/ModelObject; from L_start to L_end
+    .var 1 is par1 Ljp/ngt/ngtlib/renderer/model/IModelNGT; from L_start to L_end
+    .var 2 is par2 "[Ljp/ngt/ngtlib/renderer/model/TextureSet;" from L_start to L_end
+    .var 3 is par3 "Ljp/ngt/rtm/render/PartsRenderer;" from L_start to L_end
+    aload 0
+    invokespecial java/lang/Object/<init> ()V
+    aload 0
+    aload 1
+    putfield jp/ngt/rtm/render/ModelObject/model Ljp/ngt/ngtlib/renderer/model/IModelNGT;
+    aload 0
+    aload 2
+    putfield jp/ngt/rtm/render/ModelObject/textures "[Ljp/ngt/ngtlib/renderer/model/TextureSet;"
+    aload 0
+    iconst_0
+    putfield jp/ngt/rtm/render/ModelObject/light Z
+    aload 0
+    iconst_0
+    putfield jp/ngt/rtm/render/ModelObject/alphaBlend Z
+    aload 0
+    iconst_1
+    putfield jp/ngt/rtm/render/ModelObject/useTexture Z
+    aload 0
+    aload 3
+    putfield jp/ngt/rtm/render/ModelObject/renderer Ljp/ngt/rtm/render/PartsRenderer;
+    return
+L_end:
+.end method
+
 .method public static getDummy ()Ljp/ngt/rtm/render/ModelObject;
     .limit stack 13
     .limit local 0
 L_0000:
     .line 126
     getstatic jp/ngt/rtm/render/ModelObject/DUMMY Ljp/ngt/rtm/render/ModelObject;
     ifnonnull L_002a
 L_0004:
     .line 128
     new jp/ngt/rtm/render/ModelObject
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/render/PartsRenderer.jasm b/src/main/rtm/jp/ngt/rtm/render/PartsRenderer.jasm
index 283bb01..efd8f8d 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/render/PartsRenderer.jasm
+++ b/src/main/rtm/jp/ngt/rtm/render/PartsRenderer.jasm
@@ -173,21 +173,25 @@ L_000b:
     .end stack
     astore 3
 L_000f:
     .line 78
     .var 3 is e Ljava/lang/Exception; from L_000f to L_0021
     new java/lang/RuntimeException
     dup
     new java/lang/StringBuilder
     dup
     invokespecial java/lang/StringBuilder/<init> ()V
-    ldc "On init script : "
+    ldc "On '"
+    invokevirtual java/lang/StringBuilder/append (Ljava/lang/String;)Ljava/lang/StringBuilder;
+    aload 1
+    invokevirtual java/lang/StringBuilder/append (Ljava/lang/String;)Ljava/lang/StringBuilder;
+    ldc "' function : "
     invokevirtual java/lang/StringBuilder/append (Ljava/lang/String;)Ljava/lang/StringBuilder;
     aload 0
     getfield jp/ngt/rtm/render/PartsRenderer/modelSet Ljp/ngt/rtm/modelpack/modelset/ModelSetBase;
     invokevirtual jp/ngt/rtm/modelpack/modelset/ModelSetBase/getConfig ()Ljp/ngt/rtm/modelpack/cfg/ModelConfig;
     invokevirtual jp/ngt/rtm/modelpack/cfg/ModelConfig/getName ()Ljava/lang/String;
     invokevirtual java/lang/StringBuilder/append (Ljava/lang/String;)Ljava/lang/StringBuilder;
     invokevirtual java/lang/StringBuilder/toString ()Ljava/lang/String;
     aload 3
     invokespecial java/lang/RuntimeException/<init> (Ljava/lang/String;Ljava/lang/Throwable;)V
     athrow
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/render/RTMRenderers.jasm b/src/main/rtm/jp/ngt/rtm/render/RTMRenderers.jasm
index 222fb92..39ecbf5 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/render/RTMRenderers.jasm
+++ b/src/main/rtm/jp/ngt/rtm/render/RTMRenderers.jasm
@@ -20,30 +20,48 @@ L_0005:
 .end method
 
 .method public static varargs getRendererWithScript "(Lnet/minecraft/util/ResourceLocation;[Ljava/lang/String;)Ljp/ngt/rtm/render/PartsRenderer;"
     .signature "<R:Ljp/ngt/rtm/render/PartsRenderer;>(Lnet/minecraft/util/ResourceLocation;[Ljava/lang/String;)TR;"
     .limit stack 3
     .limit local 6
 L_0000:
     .line 17
     .var 0 is par1 Lnet/minecraft/util/ResourceLocation; from L_0000 to L_0029
     .var 1 is args "[Ljava/lang/String;" from L_0000 to L_0029
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifDisabled (Ljava/lang/String;)V
+
     getstatic jp/ngt/rtm/modelpack/ModelPackManager/INSTANCE Ljp/ngt/rtm/modelpack/ModelPackManager;
     aload 0
     invokevirtual net/minecraft/util/ResourceLocation/getPath ()Ljava/lang/String;
     invokevirtual jp/ngt/rtm/modelpack/ModelPackManager/getScript (Ljava/lang/String;)Ljava/lang/String;
     astore 2
 L_0007:
     .line 18
     .var 2 is text Ljava/lang/String; from L_0007 to L_0029
     aload 2
     invokestatic jp/ngt/ngtlib/io/ScriptUtil/doScript (Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/ifEnabled (Ljava/lang/String;)V
+
+    aconst_null
+    astore 2
+
+    aload 0
+    invokevirtual net/minecraft/util/ResourceLocation/toString ()Ljava/lang/String;
+    invokestatic com/anatawa12/fixRtm/scripting/FIXScriptUtil/getScriptAndDoScript (Ljava/lang/String;)Ljavax/script/ScriptEngine;
+
+    ldc "useOurScripting"
+    invokestatic com/anatawa12/fixRtm/asm/Preprocessor/whatever (Ljava/lang/String;)V
+
     astore 3
 L_000c:
     .line 20
     .var 3 is se Ljavax/script/ScriptEngine; from L_000c to L_0029
     aload 3
     ldc "renderClass"
     invokestatic jp/ngt/ngtlib/io/ScriptUtil/getScriptField (Ljavax/script/ScriptEngine;Ljava/lang/String;)Ljava/lang/Object;
     checkcast java/lang/String
     astore 4
 L_0013:
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/sound/MovingSoundMaker.jasm b/src/main/rtm/jp/ngt/rtm/sound/MovingSoundMaker.jasm
index 34f470e..019c243 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/sound/MovingSoundMaker.jasm
+++ b/src/main/rtm/jp/ngt/rtm/sound/MovingSoundMaker.jasm
@@ -317,20 +317,22 @@ L_0010:
     invokestatic jp/ngt/ngtlib/io/NGTJson/getGson ()Lcom/google/gson/Gson;
     aload 2
     getstatic jp/ngt/rtm/sound/MovingSoundMaker/TYPE Ljava/lang/reflect/ParameterizedType;
     invokevirtual com/google/gson/Gson/fromJson (Ljava/lang/String;Ljava/lang/reflect/Type;)Ljava/lang/Object;
     checkcast java/util/Map
     astore 3
 L_0018:
     .line 115
     .var 3 is map Ljava/util/Map; signature "Ljava/util/Map<Ljava/lang/String;Ljp/ngt/rtm/sound/MovingSoundMaker\$SoundListDummy;>;" from L_0018 to L_009c
     aload 3
+    aload 0
+    invokestatic com/anatawa12/fixRtm/rtm/HooksKt/MovingSoundMaker_loadSoundJson_nullCheck (Ljava/util/Map;Ljava/lang/String;)Ljava/util/Map;
     invokeinterface java/util/Map/entrySet ()Ljava/util/Set;
     invokeinterface java/util/Set/iterator ()Ljava/util/Iterator;
     astore 4
 L_001e:
     .stack
         locals Object java/lang/String
         locals Object java/util/Map
         locals Object java/lang/String
         locals Object java/util/Map
         locals Object java/util/Iterator
diff --git a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/world/RTMChunkManager.jasm b/src/main/rtm/jp/ngt/rtm/world/RTMChunkManager.jasm
index 478c0e0..02bf660 100644
--- a/mods/rtm.deobf.jar.src.processed/jp/ngt/rtm/world/RTMChunkManager.jasm
+++ b/src/main/rtm/jp/ngt/rtm/world/RTMChunkManager.jasm
@@ -66,108 +66,33 @@ L_0019:
         locals Object jp/ngt/rtm/world/RTMChunkManager
         locals Object net/minecraftforge/event/entity/EntityEvent$EnteringChunk
     .end stack
     return
 L_001d:
 .end method
 
 .method public getChunksAround (Ljava/util/Set;III)V
     .signature "(Ljava/util/Set<Lnet/minecraft/util/math/ChunkPos;>;III)V"
     .limit stack 5
-    .limit local 7
+    .limit local 5
 L_0000:
     .line 50
     .var 0 is this Ljp/ngt/rtm/world/RTMChunkManager; from L_0000 to L_0035
     .var 1 is set Ljava/util/Set; signature "Ljava/util/Set<Lnet/minecraft/util/math/ChunkPos;>;" from L_0000 to L_0035
     .var 2 is xChunk I from L_0000 to L_0035
     .var 3 is zChunk I from L_0000 to L_0035
     .var 4 is radius I from L_0000 to L_0035
     aload 1
-    invokeinterface java/util/Set/clear ()V
-L_0004:
-    .line 51
-    iload 2
-    iload 4
-    isub
-    istore 5
-L_000a:
-    .var 5 is xx I from L_000a to L_0031
-    .stack
-        locals Object jp/ngt/rtm/world/RTMChunkManager
-        locals Object java/util/Set
-        locals Integer
-        locals Integer
-        locals Integer
-        locals Integer
-    .end stack
-    iload 5
     iload 2
-    iload 4
-    iadd
-    if_icmpgt L_0031
-L_0011:
-    .line 53
-    iload 3
-    iload 4
-    isub
-    istore 6
-L_0017:
-    .var 6 is zz I from L_0017 to L_002c
-    .stack
-        locals Object jp/ngt/rtm/world/RTMChunkManager
-        locals Object java/util/Set
-        locals Integer
-        locals Integer
-        locals Integer
-        locals Integer
-        locals Integer
-    .end stack
-    iload 6
     iload 3
     iload 4
-    iadd
-    if_icmpgt L_002c
-L_001e:
-    .line 55
-    aload 1
-    new net/minecraft/util/math/ChunkPos
-    dup
-    iload 5
-    iload 6
-    invokespecial net/minecraft/util/math/ChunkPos/<init> (II)V
-    invokeinterface java/util/Set/add (Ljava/lang/Object;)Z
-    pop
-L_0028:
-    .line 53
-    iinc 6 1
-    goto L_0017
-L_002c:
-    .line 51
-    .stack
-        locals Object jp/ngt/rtm/world/RTMChunkManager
-        locals Object java/util/Set
-        locals Integer
-        locals Integer
-        locals Integer
-        locals Integer
-    .end stack
-    iinc 5 1
-    goto L_000a
-L_0031:
-    .line 58
-    .stack
-        locals Object jp/ngt/rtm/world/RTMChunkManager
-        locals Object java/util/Set
-        locals Integer
-        locals Integer
-        locals Integer
-    .end stack
+    invokestatic com/anatawa12/fixRtm/rtm/world/RTMChunkManagerKt/getChunksAround (Ljava/util/Set;III)V
     return
 L_0035:
 .end method
 
 .method public getNewTicket (Lnet/minecraft/world/World;Lnet/minecraftforge/common/ForgeChunkManager$Type;)Lnet/minecraftforge/common/ForgeChunkManager$Ticket;
     .limit stack 3
     .limit local 3
 L_0000:
     .line 62
     .var 0 is this Ljp/ngt/rtm/world/RTMChunkManager; from L_0000 to L_0007
